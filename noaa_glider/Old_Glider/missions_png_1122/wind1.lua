

--[[
Wind schedule for 11/14 from 11/9
--]]
local wind_sch = {
    {1505.78341627285,224.3,1.9},
    {1534.76062896396,219.2,2},
    {1592.96676175982,215.6,2.1},
    {1641.73083728328,208.3,2.2},
    {1710.40124185767,197.6,2.3},
    {1779.54565511952,189.6,2.3},
    {1849.1714526414,180,2.3},
    {1929.34294316779,175.6,2.2},
    {2030.47303314317,173.5,2.3},
    {2132.6424147462,169.2,2.2},
    {2267.05622087873,175.5,1.8},
    {2382.23578178463,187.8,2},
    {2541.50006022129,202.6,2.2},
    {2703.38953113997,234.3,2.6},
    {2879.07652256205,263.4,3.7},
    {3069.28229151409,273.1,5},
    {3263.29346838515,277,6.1},
    {3508.46904943888,285.4,6.4},
    {3760.07465570218,302.9,6.6},
    {4030.98301629228,316.1,7.5},
    {4322.74369803336,323.9,7.3},
    {4637.16221872982,325.5,6.8},
    {4990.18664841086,318.1,6.9},
    {5357.2276626205,307.8,7.5},
    {5739.59354064967,297.2,8.6},
    {6154.50536468614,287,9.1},
    {6573.04312873866,284.1,10.7},
    {7029.64470394457,288.7,11.9},
    {7529.70796347127,281.9,13.3},
    {8021.45098927461,279.3,14.3},
    {8543.27773943731,275.5,15.2},
    {9077.54035668674,271.4,15.8},
    {9648.65132169373,267.7,15.7},
    {10211.931499444,269.4,14.5},
    {10817.8012431894,273.3,14.2},
    {11444.4856113336,282.7,14.4},
    {12094.1628422764,293.9,13.4},
    {12734.1761196991,298.2,14.6},
    {13396.0397884817,298.9,15.7},
    {14124.2819827265,302.9,17.6},
    {14840.9336865429,305.8,16},
    {15535.173749959,298.7,16.8},
    {16303.0554374173,300.5,15.6},
    {17079.446135147,295.4,14.7},
    {17872.7691296227,310,14.7},
    {18687.681809928,311.7,12.3},
    {19540.923480394,307.8,12},
    {20436.3062411352,304,14.6},
    {21377.7069195228,304.3,12.4},
    {22385.0552371182,278.9,15.6},
    {22908.2416569715,275.5,16.8},
    {23451.0531328226,275.3,19.4},
    {23992.2799636203,274.4,23.1},
    {24576.750203255,275.1,25.2},
    {25156.4369293111,274.5,27.4}      
}



local last_wind_alt = 0.0

function set_wind()
    local loc = ahrs:get_position()
    local alt = loc:alt() * 0.01
    local wind_alt = 0
    local target_speed = 20.0
    local target_dir = 270.0
    local num_rows = #wind_sch
    for row = 1, num_rows do
        if alt > wind_sch[row][1] then
            wind_alt = wind_sch[row][1]
            target_dir = wind_sch[row][2]
            target_speed = wind_sch[row][3]
        end
    end

    if wind_alt ~= last_wind_alt then
        gcs:send_text(0, string.format("Sim Wind Alt %.1f/%.1f %.1f/%.1f", alt, wind_alt, target_speed, target_dir))
        param:set('SIM_WIND_SPD', target_speed)
        param:set('SIM_WIND_DIR', target_dir)
        last_wind_alt = wind_alt
    end
    
end

function print_ahrs() 
    local velVar = ahrs:get_velocity_NED()
    --local wind = ahrs:wind_estimate()
    if velVar then 
        gcs:send_text(0, string.format("VEL %.1f,%.1f,%.1f", velVar:x(), velVar:y(), velVar:z()))
    end 
end

function update_wind()
    set_wind() 
    --print_ahrs()
    return update_wind,5000
end 



gcs:send_text(0, string.format("------Wind Loader-------- "))

return update_wind,10000