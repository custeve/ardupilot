

--[[
Wind schedule for 11/15 from 11/9
--]]
local wind_sch = {
    {1515.43321803547,196.3,3.9},
    {1573.52723980065,195.2,4.3},
    {1612.44397791876,197.1,4.6},
    {1671.10343462136,195.1,4.5},
    {1720.24982412585,191.4,4.6},
    {1799.38929229511,194.4,4.8},
    {1879.160308477,190.8,5.4},
    {1969.6717760221,182.8,6.3},
    {2061.01363856494,184.4,7.3},
    {2163.49948294372,185.6,7.8},
    {2277.47176126206,189.6,8.2},
    {2403.32274759779,194.5,8.7},
    {2552.20995694113,200.7,9},
    {2714.27788823576,205.9,9},
    {2890.16272672547,212.4,8.7},
    {3080.58772610302,218.3,7.9},
    {3286.37646662555,225.7,6.9},
    {3520.30151446246,232.3,6},
    {3784.38633935151,235.6,5.8},
    {4055.99883721205,236.2,5.7},
    {4348.54628597093,241.9,6.1},
    {4650.49517957241,250.7,6.6},
    {5004.03661284567,260.6,7.6},
    {5357.2276626205,264.1,9.3},
    {5754.62569877261,261.3,11.7},
    {6154.50536468614,260.9,13.7},
    {6589.54024869741,262.4,14.3},
    {7047.0193384663,265.8,13.8},
    {7529.70796347127,270,13.3},
    {8021.45098927461,274.1,13.2},
    {8543.27773943731,274.6,13.6},
    {9099.64069303659,278.5,14},
    {9648.65132169373,281.2,14.4},
    {10237.3377888245,280.3,16.5},
    {10817.8012431894,275.5,15.5},
    {11444.4856113336,268.1,15.8},
    {12061.9388222539,266.4,17.7},
    {12734.1761196991,275.4,19.9},
    {13396.0397884817,287.6,21.1},
    {14124.2819827265,294.9,21.6},
    {14840.9336865429,295.3,19.3},
    {15535.173749959,296.2,17.6},
    {16303.0554374173,295.9,16.1},
    {17079.446135147,291.1,15.9},
    {17872.7691296227,295.5,15.5},
    {18687.681809928,291.8,13.9},
    {19540.923480394,296.8,13.7},
    {20436.3062411352,294.1,11.4},
    {21377.7069195228,287.6,13.9},
    {22385.0552371182,290.1,16.6},
    {22908.2416569715,284,20.4},
    {23451.0531328226,273.2,22.2},
    {23992.2799636203,269.5,25.1},
    {24576.750203255,269,25.1},
    {25156.4369293111,263.3,26.8}        
}



local last_wind_alt = 0.0

function set_wind()
    local loc = ahrs:get_position()
    local alt = loc:alt() * 0.01
    local wind_alt = 0
    local target_speed = 20.0
    local target_dir = 270.0
    local num_rows = #wind_sch
    for row = 1, num_rows do
        if alt > wind_sch[row][1] then
            wind_alt = wind_sch[row][1]
            target_dir = wind_sch[row][2]
            target_speed = wind_sch[row][3]
        end
    end

    if wind_alt ~= last_wind_alt then
        gcs:send_text(0, string.format("Sim Wind Alt %.1f/%.1f %.1f/%.1f", alt, wind_alt, target_speed, target_dir))
        param:set('SIM_WIND_SPD', target_speed)
        param:set('SIM_WIND_DIR', target_dir)
        last_wind_alt = wind_alt
    end
    
end

function print_ahrs() 
    local velVar = ahrs:get_velocity_NED()
    --local wind = ahrs:wind_estimate()
    if velVar then 
        gcs:send_text(0, string.format("VEL %.1f,%.1f,%.1f", velVar:x(), velVar:y(), velVar:z()))
    end 
end

function update_wind()
    set_wind() 
    --print_ahrs()
    return update_wind,5000
end 



gcs:send_text(0, string.format("------Wind Loader-------- "))

return update_wind,10000